# fix-diff

A utility to fix line numbers in unified diffs, particularly those generated by Language Models (LLMs). It follows the Unix philosophy of doing one thing well: correcting line numbers in diffs while preserving the actual changes.

## Problem

LLMs often generate patches with correct content but incorrect line numbers, making them incompatible with tools like `patch` or `git apply`. This tool automatically adjusts the line numbers by matching the context lines with the actual file content.

## Features

- Fixes line numbers in unified diff format
- Handles both stdin/stdout and file inputs
- Supports fuzzy matching for context lines
- Follows Unix philosophy (composable with other tools)
- Verbose mode for debugging

## Installation

```bash
# Clone the repository
git clone https://github.com/yourusername/fix-diff.git
cd fix-diff

# Make the script executable
chmod +x fix-diff.sh

# Optional: Add to your PATH for system-wide access
sudo ln -s "$(pwd)/fix-diff.sh" /usr/local/bin/fix-diff
```

## Usage

```bash
# Basic usage (stdin to stdout)
cat broken.diff | fix-diff > fixed.diff

# Using files
fix-diff -i broken.diff -o fixed.diff

# Verbose mode
fix-diff -i broken.diff -o fixed.diff -v

# Common usage with clipboard and patch
pbpaste | fix-diff | patch -p1 -l --verbose

# Help
fix-diff -h
```

### Options

- `-i FILE`: Input generated diff file (default: stdin)
- `-o FILE`: Output corrected diff file (default: stdout)
- `-v`: Enable verbose logging to stderr
- `-h`: Show help and exit

## How It Works

1. Reads the input diff
2. Extracts affected file names and verifies their existence
3. For each hunk in the diff:
   - Finds the first unchanged context line
   - Locates this line in the actual file
   - Updates the hunk's line numbers accordingly
4. Outputs the corrected diff

## Examples

```bash
# Fix a diff from clipboard and apply it
pbpaste | fix-diff | git apply

# Fix a diff file and save the result
fix-diff -i my_changes.diff -o fixed_changes.diff

# Fix a diff with verbose output for debugging
cat broken.diff | fix-diff -v > fixed.diff
```

## Requirements

- Bash
- Core Unix utilities (awk, sed, grep)

## Limitations

- Files referenced in the diff must exist in the current directory
- Context lines must match (or nearly match) the target files
- Only works with unified diff format

## Contributing

Pull requests are welcome! Please make sure to update tests as appropriate.

## License

[MIT License](LICENSE)
